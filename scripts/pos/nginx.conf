worker_processes auto;
daemon off;

events {
    worker_connections 1024;
}

http {
    server_tokens off;
    sendfile off;
    client_max_body_size 1m;

    access_log /dev/null;
    error_log /dev/null crit;

    proxy_http_version 1.1;
    proxy_ssl_server_name on;

    proxy_cache_path /tmp/cache levels=1 keys_zone=STATIC:20m inactive=1h;
    proxy_cache STATIC;
    proxy_cache_valid 200 1m;
    proxy_cache_lock on;
    proxy_cache_background_update on;

    add_header 'x-cache-' $upstream_cache_status;

    upstream CDN {
        server 127.0.0.1:8000 weight=W_MAIN;
        server 127.0.0.1:8001 weight=W_CANARY;
        server 127.0.0.1:8002 weight=W_CANARY;
    }

    server {
        listen 80;

        location / {
            proxy_pass http://CDN;
            proxy_cache off;

            add_header 'access-control-allow-origin' '*';
            add_header 'cache-control' 'max-age=120';

            proxy_hide_header 'access-control-allow-origin';
            proxy_hide_header 'x-cache';
            proxy_hide_header 'via';
            proxy_hide_header 'x-amz-cf-pop';
            proxy_hide_header 'x-amz-server-side-encryption';
            proxy_hide_header 'x-amz-cf-id';
            proxy_hide_header 'cache-control';
        }
    }

    server {
        listen 8000;

        location / {
            proxy_pass https://checkout-static.razorpay.com;

        }
    }

    server {
        listen 8001;

        location / {
            proxy_pass https://checkout-static-canary.razorpay.com;
        }
    }

    server {
        listen 8002;

        location / {
            proxy_pass https://checkout-static-baseline.razorpay.com;
        }
    }
}
