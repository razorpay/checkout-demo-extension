name: 'Prod: Build & push to Harbor'

# Controls when the action will run. Triggers the workflow on every push
on: [push]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  make-build:
    runs-on: [self-hosted]
    steps:
      - name: Checkout Codebase
        uses: actions/checkout@v2
      - name: Use Node v16
        uses: actions/setup-node@v1
        with:
          node-version: 16.10.0
      - name: Install Dependencies
        run: npm ci
      - name: Run Unit Tests
        run: npm run test:unit
      - name: Make Build
        run: npm run build
      - name: Cache Build
        id: cache-build
        uses: actions/cache@v3
        with:
          path: |
            app/dist
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
  customFTs:
    name: custom-fts
    needs: [make-build]
    runs-on: [self-hosted]
    container: satantime/puppeteer-node
    steps:
      - name: Checkout Codebase
        uses: actions/checkout@v2
      - name: Use Node v16
        uses: actions/setup-node@v1
        with:
          node-version: 16.10.0
      - name: Cache build
        id: cache-build
        uses: actions/cache@v3
        with:
          path: |
            app/dist
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-
      - name: Install Dependencies
        run: npm ci
      - name: Run Custom Checkout FTs
        run: NODE_ENV=production npm run jest:custom
      - name: Run Misc FTs
        run: NODE_ENV=production npx jest blackbox/tests/misc/**/*.test.js
  functional-test:
    name: functional-tests
    needs: [make-build]
    runs-on: [self-hosted]
    container: satantime/puppeteer-node
    strategy:
      matrix:
        shard: [1/3, 2/3, 3/3]
    steps:
      - name: Checkout Codebase
        uses: actions/checkout@v2
      - name: Use Node v16
        uses: actions/setup-node@v1
        with:
          node-version: 16.10.0
      - name: Cache build
        id: cache-build
        uses: actions/cache@v3
        with:
          path: |
            app/dist
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-
      - name: Install Dependencies
        run: npm ci
      - name: Run Fts
        run: NODE_ENV=production npx jest blackbox/tests/homescreen/**/*.test.js --shard=${{ matrix.shard }} --runInBand
  fts:
    needs: [customFTs, functional-test]
    name: fts
    runs-on: [self-hosted]
    if: always()
    steps:
      - name: verify failure
        if: always() && (needs.customFTs.result == 'failure' || needs.functional-test.result == 'failure')
        run: exit 1
      - name: Fts Done
        run: echo "All Tests Passed"
  build-and-push-image: # independent of rest
    name: build and push
    runs-on: [self-hosted]
    env:
      AWS_S3_BUCKET_FOR_BUILD: rzp-1018-nonprod-betacdn
      AWS_REGION_FOR_BUILD: ap-south-1
      AWS_ACCESS_KEY: ${{ secrets.STAGE_AWS_ACCESS_KEY }}
      AWS_ACCESS_SECRET: ${{ secrets.STAGE_AWS_SECRET_KEY }}
      BUCKET_BASE_PATH_FOR_BRANCH: checkout/builds/branch-builds
      BUCKET_BASE_PATH_FOR_COMMIT: checkout/builds/commit-builds
      RUN_BUILD_NUMBER: ${{ github.run_id }}
      GIT_COMMIT_HASH: ${{ github.sha }}

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - uses: actions/checkout@v2
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Declare some variables
        id: vars
        shell: bash
        run: |
          echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
          echo "SHORT_SHA=`echo ${GITHUB_SHA} | cut -c1-8`" >> $GITHUB_ENV
      - name: Set up Docker Buildx
        id: docker
        uses: docker/setup-buildx-action@v2
        with:
          install: true
      - name: Login to Harbor
        id: harbor
        uses: docker/login-action@v1
        with:
          registry: c.rzp.io
          username: ${{ secrets.HARBOR_DOCKER_USERNAME }}
          password: ${{ secrets.HARBOR_DOCKER_PASSWORD }}
      - name: Build and push to Harbor
        id: build
        env:
          # build number prefix for master: null
          CURRENT_BUILD_NUMBER: '${{ env.RUN_BUILD_NUMBER }}'
          BUILD_PATH_FOR_BRANCH: '${{ env.BUCKET_BASE_PATH_FOR_BRANCH }}/${{ steps.vars.outputs.branch }}'
          BUILD_PATH_FOR_COMMIT: '${{ env.BUCKET_BASE_PATH_FOR_COMMIT }}/${{ env.GIT_COMMIT_HASH }}'
        uses: docker/build-push-action@v3
        with:
          file: ./Dockerfile
          build-args: | # nosemgrep : https://semgrep.dev/s/lJpo
            "AWS_S3_BUCKET_FOR_BUILD=${{ env.AWS_S3_BUCKET_FOR_BUILD }}"
            "AWS_REGION_FOR_BUILD=${{ env.AWS_REGION_FOR_BUILD }}"
            "AWS_ACCESS_KEY=${{ env.AWS_ACCESS_KEY }}"
            "AWS_ACCESS_SECRET=${{ env.AWS_ACCESS_SECRET }}"
            "BUILD_NUMBER=${{ env.CURRENT_BUILD_NUMBER }}"
            "BUILD_PATH_FOR_BRANCH=${{ env.BUILD_PATH_FOR_BRANCH }}"
            "BUILD_PATH_FOR_COMMIT=${{ env.BUILD_PATH_FOR_COMMIT }}"
            "GIT_COMMIT_HASH=${{ env.GIT_COMMIT_HASH }}"
          push: true
          tags: c.rzp.io/razorpay/checkout:${{ github.sha }}
      - name: Mark workflow status as failed
        id: failed
        if: steps.vars.outcome != 'success' || steps.docker.outcome != 'success' || steps.harbor.outcome != 'success' || steps.build.outcome != 'success'
        run: |
          echo 'Failing the workflow for github status check.'
          curl -X POST -H "Content-Type: application/json" -H "Authorization: token ${{ github.token }}" \
          -d '{ "state" : "failure" , "context" : "github/combined-status-check" , "description" : "github/combined-status-check", "target_url" : "https://github.com/${{ github.repository }}" }' \
          https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}
          exit 1
      - name: Mark workflow status as success
        if: steps.failed.conclusion == 'skipped'
        run: |
          echo 'Status check has passed! Build number ${{ github.run_id }} , commit-id: ${{ github.sha }} '
          curl -X POST -H "Content-Type: application/json" -H "Authorization: token ${{ github.token }}" \
          -d '{ "state" : "success" , "context" : "github/combined-status-check" , "description" : "github/combined-status-check", "target_url" : "https://github.com/${{ github.repository }}" }' \
          https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}
          exit 0
