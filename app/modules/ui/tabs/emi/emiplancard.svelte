<script>
  // Util imports
  import Razorpay from 'common/Razorpay';
  import { getSession } from 'sessionmanager';
  import { roundUpToNearestMajor } from 'common/currency';

  // UI imports
  import ExpandableCard from 'ui/elements/ExpandableCard.svelte';

  // i18n
  import { t, locale } from 'svelte-i18n';
  import { formatTemplateWithLocale } from 'i18n';

  import {
    PLAN_TITLE,
    NO_COST_LABEL,
    INTEREST_CHARGED_LABEL,
    NO_COST_DISCOUNT_LABEL,
    NO_COST_EXPLAIN_ACTION,
    CREDIT_EMI_DESCRIPTION,
    HDFC_DEBIT_DESCRIPTION_MIN_BALANCE,
    HDFC_DEBIT_DESCRIPTION_INCLUDES_INTEREST,
    HDFC_DEBIT_DESCRIPTION_CONVENIENCE,
    DESCRIPTION_MONTHLY_INSTALLMENT,
    DESCRIPTION_TOTAL_AMOUNT,
  } from 'ui/labels/emi';

  // Props
  export let amount;
  export let plan;
  export let bank;
  export let provider;
  export let expanded;

  // Computed
  export let amountPerMonth;
  export let formattedAmount;
  export let formattedAmountPerMonth;
  export let formattedFinalAmount;
  export let isCardEmi;
  export let noCostEmi;
  export let showInterest;

  let interestChargedByBank;

  const session = getSession();
  const HDFC_BANK_CODE = 'HDFC';
  const HDFC_BANK_DEBIT_CODE = 'HDFC_DC';

  // amountPerMonth
  $: {
    // Don't calculate if amount_per_month exists
    if (plan.amount_per_month) {
      amountPerMonth = plan.amount_per_month;
    } else {
      amountPerMonth = Razorpay.emi.calculator(
        amount,
        plan.duration,
        plan.interest
      );
    }
  }

  $: {
    if (bank === 'BAJAJ' && amountPerMonth) {
      amountPerMonth = roundUpToNearestMajor(
        amountPerMonth,
        session.get('currency')
      );
    }
  }

  $: {
    noCostEmi =
      plan.subvention === 'merchant' ||
      (provider === 'zestmoney' && plan.duration === 3);
    if (noCostEmi && plan.merchant_payback) {
      interestChargedByBank = session.formatAmountWithCurrency(
        amount / (1 - plan.merchant_payback / 100) - amount
      );
    }
  }
  $: isCardEmi = !provider;
  $: showInterest =
    !isCardEmi || !_Arr.contains(['zestmoney', 'earlysalary'], provider);
  $: formattedAmount = session.formatAmountWithCurrency(amount);
  $: formattedAmountPerMonth = session.formatAmountWithCurrency(amountPerMonth);
  $: formattedFinalAmount = session.formatAmountWithCurrency(
    plan.duration * amountPerMonth
  );

  function explain() {
    session.showNoCostExplainer(plan);
  }
</script>

<style>
  span.inline-block {
    display: inline-block;
  }
  .how-it-works {
    margin-top: 6px;
  }
  .right {
    float: right;
  }
  .nocost {
    line-height: 20px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    margin: -10px 0 6px !important;
    padding-bottom: 6px;
  }
</style>

<ExpandableCard showRadio {expanded} on:click>
  <div slot="title">
    <!-- LABEL: {duration} Months ({amount}/mo) -->
    {formatTemplateWithLocale(PLAN_TITLE, { duration: plan.duration, amount: formattedAmountPerMonth }, $locale)}
    {#if showInterest}
      &nbsp;@ {(noCostEmi && $t(NO_COST_LABEL)) || `${plan.interest}%`}
    {/if}
  </div>
  <div slot="detail">
    {#if noCostEmi}
      <ul class="nocost">
        <li>
          <!-- LABEL: Interest charged by the bank -->
          {$t(INTEREST_CHARGED_LABEL)}
          <span class="right">{interestChargedByBank}</span>
        </li>
        <li class="theme-highlight">
          <!-- LABEL: No Cost EMI offer discount -->
          {$t(NO_COST_DISCOUNT_LABEL)}
          <span class="right">- {interestChargedByBank}</span>
        </li>
      </ul>
    {/if}
    {#if isCardEmi}
      {#if bank === HDFC_BANK_DEBIT_CODE}
        <!-- TODO: Combine both labels and allow inline-block from within template -->
        <!-- LABEL: No minimum balance is required. There will be no amount blocked on your
        card. You will pay -->
        {$t(HDFC_DEBIT_DESCRIPTION_MIN_BALANCE)}
        <span class="inline-block">{formattedAmountPerMonth}/mo</span>
        <!-- LABEL: (includes interest). -->
        {$t(HDFC_DEBIT_DESCRIPTION_INCLUDES_INTEREST)}
      {:else}
        <!-- LABEL: Full amount of {formattedAmount} will be deducted from your account,
        which will be converted into EMI by your bank in 3-4 days. -->
        {formatTemplateWithLocale(CREDIT_EMI_DESCRIPTION, { amount: formattedAmount }, $locale)}
      {/if}
      {#if bank === HDFC_BANK_CODE || bank === HDFC_BANK_DEBIT_CODE}
        <!-- LABEL: Convenience Fee of â‚¹99 + GST applicable for EMI transactions on HDFC
        Bank Cards. -->
        {$t(HDFC_DEBIT_DESCRIPTION_CONVENIENCE)}
      {/if}
    {:else}
      <ul>
        <!-- LABEL: Monthly Installment: {amount} -->
        <li>
          {formatTemplateWithLocale(DESCRIPTION_MONTHLY_INSTALLMENT, { amount: formattedAmountPerMonth }, $locale)}
        </li>
        <!-- LABEL: Total Amount: {formattedFinalAmount} ({formattedAmountPerMonth} x {plan.duration}) -->
        <li>
          {formatTemplateWithLocale(DESCRIPTION_TOTAL_AMOUNT, { totalAmount: formattedFinalAmount, monthlyAmount: formattedAmountPerMonth, duration: plan.duration }, $locale)}
        </li>
      </ul>
    {/if}
    {#if noCostEmi}
      <div class="theme-highlight how-it-works" on:click={explain}>
        + How does it work?
      </div>
    {/if}
  </div>

</ExpandableCard>
