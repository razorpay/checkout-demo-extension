box: pronav/checkout
build:
    steps:
        - script:
            name: npm install
            code: npm install --no-optional
        - script:
            name: Test
            code: gulp test

    after-steps:
        - williamli/slack-notify-no-owner-info:
            subdomain: razorpay
            token: $SLACK_TOKEN
            channel: tech_bots
deploy:
    steps:
        - script:
            name: npm install
            code: npm install

        - script:
            name: Insert git commit id into rollbar version
            code: sed -i -e "s/VERSIONSTRING/$WERCKER_GIT_COMMIT/" app/js/rollbar.js

        - script:
            name: build
            code: gulp

        - script:
            name: 'Upload source maps'
            code: 'FILE=checkout-frame.js; PREFIX=https://; if [ "$WERCKER_DEPLOYTARGET_NAME" == "Beta" ]; then PREFIX+=beta; fi; PREFIX+=checkout.razorpay.com/v1/; curl "https://api.rollbar.com/api/1/sourcemap" -F access_token=$ROLLBAR_TOKEN -F version=$WERCKER_GIT_COMMIT -F minified_url=$PREFIX$FILE -F source_map=@app/dist/v1/$FILE.map; echo $PREFIX$FILE'

        - script:
            name: 'Remove map files'
            code: rm app/dist/v1/*.map

        - script:
            name: 'Upload fonts'
            code: gulp fontUpload --target=$WERCKER_DEPLOYTARGET_NAME

        - nhuray/aws-code-deploy:
            key: $AWS_KEY
            secret: $AWS_SECRET
            region: $AWS_REGION
            application-name: Checkout
            deployment-group-name: $WERCKER_DEPLOYTARGET_NAME
            s3-bucket: rzp-codedeploy

        - script:
            name: Cloudfront cache invalidate
            code: node scripts/invalidate.js

    after-steps:
        - williamli/slack-notify-no-owner-info:
            subdomain: razorpay
            token: $SLACK_TOKEN
            channel: tech_bots
        - script:
            name: Bozo Regression Analysis
            code: if [ "$WERCKER_RESULT" != "failed" ]; then curl "http://rzp.cloudapp.net:8000/screenshot/$BOZO_TOKEN" -d "commit=$WERCKER_GIT_COMMIT&branch=$WERCKER_GIT_BRANCH&target=$WERCKER_DEPLOYTARGET_NAME"; fi;
