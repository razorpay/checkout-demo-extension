box: pronav/checkout
build:
    steps:
        - npm-install

        - script:
            name: Unit Test
            code: gulp test:unit

        - script:
            name: Test
            code: /selenium & npm run test:prod

    after-steps:
        - slack-notifier:
            url: $SLACK_URL
            channel: tech_bots
            username: wercker
            icon_url: https://cdn.rawgit.com/wantedly/step-pretty-slack-notify/master/icons/$WERCKER_RESULT.jpg
deploy:
    steps:
        - script:
            name: build
            code: gulp

        - nhuray/aws-code-deploy:
            key: $AWS_KEY
            secret: $AWS_SECRET
            region: $AWS_REGION
            application-name: checkout
            deployment-group-name: $WERCKER_DEPLOYTARGET_NAME
            s3-bucket: rzp-code-deploy

        - script:
            name: Cloudfront cache invalidate
            code: node scripts/invalidate.js

    after-steps:
        - slack-notifier:
            url: $SLACK_URL
            channel: tech_bots
            username: wercker
            icon_url: https://cdn.rawgit.com/wantedly/step-pretty-slack-notify/master/icons/$WERCKER_RESULT.jpg
        - script:
            name: Bozo Regression Analysis
            code: if [ "$WERCKER_RESULT" != "failed" ]; then curl "http://rzp.cloudapp.net:8000/screenshot/$BOZO_TOKEN" -d "commit=$WERCKER_GIT_COMMIT&branch=$WERCKER_GIT_BRANCH&target=$WERCKER_DEPLOYTARGET_NAME"; fi;
